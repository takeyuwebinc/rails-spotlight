# 新機能開発プロセスガイドライン

## 概要

このドキュメントは、新機能開発時の標準的なプロセスと成果物について定義します。すべての新機能開発は、このガイドラインに従って進めることで、品質と保守性を確保します。

## 開発プロセスフロー

### 1. 調査フェーズ（必要に応じて）

新機能に関する技術的な調査が必要な場合：

- **成果物**: 調査報告書
- **保存場所**: `docs/reports/YYYYMMDD_[調査内容].md`
- **例**: `docs/reports/20250531_websocket_implementation_research.md`

調査報告書には以下を含める：
- 調査の背景と目的
- 検討した技術オプション
- 各オプションの長所・短所
- 推奨事項と理由
- 参考資料とリンク

### 2. 仕様書作成フェーズ（必須）

**重要**: すべての新機能開発は、実装前に必ず仕様書を作成すること。

- **成果物**: 機能仕様書
- **保存場所**: `docs/specs/[機能名].md`
- **例**: `docs/specs/user_notification_system.md`

仕様書には以下を含める：
- 機能の概要と目的
- ユースケース
- 技術的な設計
  - データモデル
  - API仕様（該当する場合）
  - UI/UXの概要
- 実装方針
- テスト計画
- セキュリティ考慮事項
- パフォーマンス目標

### 3. 実装フェーズ

仕様書に基づいて実装を進める：

1. **ブランチ作成**
   ```bash
   git checkout -b feature/[機能名]
   ```

2. **実装の進め方**
   - 仕様書を参照しながら実装
   - 必要に応じて仕様書を更新
   - コミットメッセージは明確に

3. **コーディング規約**
   - CLAUDE.md に定義されたルールに従う
   - Rails標準機能を優先使用
   - テストファーストで開発

### 4. テストフェーズ

- **ユニットテスト**: ビジネスロジックは必須
- **Request specs**: Controllerのテスト
- **System specs**: 重要なユーザーフローのE2Eテスト
- **API仕様**: rswagでOpenAPI 3.0仕様を生成
- **UI確認テスト**: PuppeteerによるUI要素の視覚的確認（詳細は下記参照）

### 5. ドキュメント更新

実装完了後、以下のドキュメントを更新：

1. **仕様書の最終化**
   - 実装中の変更を反映
   - 今後の改善点を記載

2. **ADR作成**（該当する場合）
   - 主要な技術的判断を記録
   - 保存場所: `docs/adr/`
   - フォーマット: `XXX_[決定内容].md`

3. **README更新**（必要に応じて）
   - 新機能の使い方
   - 設定方法

## 成果物一覧

| フェーズ | 成果物 | 保存場所 | 必須/任意 |
|---------|--------|----------|-----------|
| 調査 | 調査報告書 | `docs/reports/YYYYMMDD_[内容].md` | 任意 |
| 設計 | 機能仕様書 | `docs/specs/[機能名].md` | **必須** |
| 設計 | ADR | `docs/adr/XXX_[決定内容].md` | 任意 |
| 実装 | ソースコード | 各ディレクトリ | 必須 |
| 実装 | テストコード | `spec/` | 必須 |
| 実装 | API仕様 | `swagger/` | API開発時必須 |

## チェックリスト

新機能開発前：
- [ ] 仕様書を作成したか
- [ ] 必要な調査を完了したか
- [ ] 既存機能への影響を検討したか

実装中：
- [ ] 仕様書に沿って実装しているか
- [ ] テストを書いているか
- [ ] コーディング規約に従っているか
- [ ] UI変更がある場合、Puppeteerテストを準備したか

実装後：
- [ ] すべてのテストが通るか
- [ ] UI要素の表示・動作をPuppeteerで確認したか（UI変更時）
- [ ] 仕様書を最新化したか
- [ ] 必要なドキュメントを更新したか
- [ ] コードレビューを受けたか

## PuppeteerによるUI確認テスト

### 概要

UI要素の表示や動作を視覚的に確認するため、Puppeteerを使用したテストを実施します。特に以下の場合に有効です：

- レスポンシブデザインの確認（デスクトップ/モバイル）
- インタラクティブな要素の動作確認（折りたたみ、展開など）
- ダークモード対応の確認
- スクリーンショットによる視覚的な記録

### 実施方法

1. **テストスクリプトの作成**
   ```javascript
   // script/check_[feature_name].js
   const puppeteer = require('puppeteer');
   // ... テストコード
   ```

2. **確認項目の例**
   - 要素の表示/非表示
   - クリックイベントの動作
   - レスポンシブデザインの切り替わり
   - アニメーションの完了
   - フォームの入力と送信

3. **スクリーンショットの保存**
   - 保存先: `tmp/screenshots/`
   - 命名規則: `[feature]-[state]-[viewport].png`
   - 例: `mobile-toc-expanded-mobile.png`

### 実践例

```javascript
// モバイル目次の展開/折りたたみテスト
const browser = await puppeteer.launch({ headless: 'new' });
const page = await browser.newPage();
await page.setViewport({ width: 375, height: 667 }); // モバイルビュー

// 目次の展開前
await page.screenshot({ path: 'tmp/screenshots/toc-collapsed.png' });

// クリックして展開
await page.click('details summary');
await page.waitForTimeout(500); // アニメーション待機

// 展開後
await page.screenshot({ path: 'tmp/screenshots/toc-expanded.png' });
```

### ベストプラクティス

1. **環境設定**
   - DevContainer内でのChromium依存関係をDockerfileに含める
   - `--no-sandbox`オプションでコンテナ内実行に対応

2. **待機処理**
   - `waitForSelector`で要素の出現を待つ
   - アニメーション完了のための適切な待機時間を設定

3. **エラーハンドリング**
   - try-finallyでブラウザのクローズを保証
   - エラー時もスクリーンショットを保存して原因調査に活用

4. **実行タイミング**
   - 新機能実装後の確認
   - UI関連のバグ修正後の検証
   - デプロイ前の最終確認

## 参考資料

- [CLAUDE.md](/CLAUDE.md) - コーディング規約とプロジェクトルール
- [ADRテンプレート](/docs/adr/template.md) - ADR作成時のテンプレート
- [既存の仕様書例](/docs/specs/) - 過去の仕様書サンプル
- [Puppeteer公式ドキュメント](https://pptr.dev/) - Puppeteer APIリファレンス