# カスタムMarkdown仕様書

## 概要

このドキュメントでは、Spotlight Railsアプリケーションで使用されているカスタムMarkdown機能の仕様を説明します。このカスタムMarkdown実装は、標準的なMarkdown構文に加えて、折りたたみ可能な詳細ブロック、メッセージブロック、アラートメッセージブロックなどの拡張機能を提供します。

## 基本実装

カスタムMarkdownの実装は、以下のコンポーネントで構成されています：

1. **CustomHtmlRenderer**: Redcarpetライブラリを拡張したカスタムレンダラー
2. **Stimulus.js コントローラ**: 折りたたみ機能などのインタラクティブな要素を制御
3. **Tailwind CSS**: スタイリングとレスポンシブデザイン

## カスタムブロック構文

### リンクカード (Link Card)

URLのみの行を自動的にリンクカードとして表示します。リンクカードはURLのメタデータ（タイトル、説明、サムネイル画像など）を取得して表示します。

#### 構文

```markdown
https://example.com
```

#### レンダリング結果

- URLのメタデータを取得して表示するカード
- タイトル、説明、ドメイン情報、サムネイル画像（利用可能な場合）を表示
- カードをクリックするとリンク先に移動
- メタデータはAjaxで非同期に取得されるため、ページの初期表示は高速

### 詳細ブロック (Details)

折りたたみ可能なコンテンツブロックを作成します。タイトルをクリックすると内容の表示/非表示を切り替えられます。

#### 構文

```markdown
:::details タイトル
詳細内容をここに記述
:::
```

または、ネストされたブロック用に4つのコロンを使用：

```markdown
::::details タイトル
詳細内容をここに記述

:::message
ネストされたメッセージ
:::

さらにテキスト
::::
```

#### レンダリング結果

- 灰色のボーダーを持つ折りたたみ可能なブロック
- タイトルバーにはタイトルテキストと折りたたみ状態を示す矢印アイコン
- 初期状態では内容は非表示
- クリックすると内容が表示され、矢印の向きが変わる

### メッセージブロック (Message)

強調されたメッセージを表示するためのブロック。

#### 構文

```markdown
:::message
メッセージ内容をここに記述
:::
```

または、ネストされたブロック用に4つのコロンを使用：

```markdown
::::message
メッセージ内容をここに記述
::::
```

#### レンダリング結果

- 琥珀色の左ボーダーと背景を持つブロック
- テキストは琥珀色で表示
- コードブロックなど他のMarkdown要素も内部に含めることが可能

### アラートメッセージブロック (Alert Message)

警告や重要な情報を強調するためのブロック。

#### 構文

```markdown
:::message alert
アラートメッセージ内容をここに記述
:::
```

または、ネストされたブロック用に4つのコロンを使用：

```markdown
::::message alert
アラートメッセージ内容をここに記述
::::
```

#### レンダリング結果

- 赤色の左ボーダーと背景を持つブロック
- テキストは赤色で表示
- 警告や重要な情報を目立たせるのに適している

## ネスト機能

カスタムブロックは互いにネストすることができます。ネストする場合は、外側のブロックに4つのコロン（`::::`)、内側のブロックに3つのコロン（`:::`)を使用します。

### 例

```markdown
::::details 外側のタイトル
外側のテキスト

:::details 内側のタイトル
内側のテキスト
:::

:::message
内側のメッセージ
:::

外側の続き
::::
```

## コードブロックとの併用

カスタムブロック内では、標準的なMarkdownのコードブロックを使用できます。

### 例

```markdown
:::message
コードブロック:

```ruby
def hello
  puts "Hello, world!"
end
```
:::
```

## 技術的実装

### レンダリングプロセス

1. **前処理 (preprocess)**:
   - カスタムブロック構文を検出し、一時的なプレースホルダーに置き換え
   - プレースホルダーとブロック情報をマッピングして保存

2. **Markdown変換**:
   - 標準的なMarkdown構文をHTMLに変換

3. **後処理 (postprocess)**:
   - プレースホルダーを対応するHTMLに置き換え
   - ネストされたブロックを再帰的に処理

### インタラクティブ機能

詳細ブロックの折りたたみ機能は、Stimulus.jsコントローラによって制御されます：

- **details_controller.js**: 詳細ブロックの表示/非表示を切り替え
- 初期状態では内容は非表示（`hidden`クラスを適用）
- クリック時に内容の表示/非表示を切り替え、矢印アイコンの回転も制御

リンクカード機能も、Stimulus.jsコントローラによって制御されます：

- **link_card_controller.js**: URLからメタデータを取得してリンクカードを表示
- ページ読み込み後にAjaxリクエストでメタデータを取得
- 取得したメタデータを使用してリンクカードを動的に生成
- エラー時は元のリンクをそのまま表示

### APIエンドポイント

リンクカード機能は、以下のAPIエンドポイントを使用してURLのメタデータを取得します：

- **GET /api/link_cards/metadata**: URLからメタデータを取得するエンドポイント
  - パラメータ: `url` - メタデータを取得するURL
  - レスポンス: JSONオブジェクト（タイトル、説明、ドメイン、ファビコン、画像URL）
  - エラー処理: URLが無効な場合やメタデータ取得に失敗した場合はエラーレスポンスを返す

### スタイリング

Tailwind CSSを使用して、各ブロックタイプに適したスタイルを適用：

- **リンクカード**: 白い背景、角丸、影効果、ホバー時の強調表示
- **詳細ブロック**: 灰色のボーダー、角丸、タイトルバーのホバー効果
- **メッセージブロック**: 琥珀色の左ボーダーと背景、琥珀色のテキスト
- **アラートブロック**: 赤色の左ボーダーと背景、赤色のテキスト

## 目次機能との連携

カスタムMarkdownは、アプリケーションの目次機能と連携しています：

- 記事内の見出し（h2, h3, h4, h5, h6）を自動的に検出
- 見出しレベルに応じた階層構造を持つ目次を生成
- 目次項目をクリックすると、対応する見出しへスムーズにスクロール
- 記事をスクロールすると、現在表示されている見出しに対応する目次項目がハイライト

## 使用例

### リンクカードの例

```markdown
# インストール方法

Kamalのウェブサイトを参照してください：

https://kamal-deploy.org

詳細なドキュメントはGitHubリポジトリにあります：

https://github.com/basecamp/kamal
```

### 詳細ブロックの例

```markdown
:::details Rubyがインストールされている場合

```bash
gem install kamal
```

または bundle で導入

```bash
bundle add kamal --group development
```
:::
```

### メッセージブロックの例

```markdown
:::message
今後 Real World での運用で得た知見を記事に追記していく予定です。
:::
```

### アラートメッセージブロックの例

```markdown
:::message alert
アクセサリのデータディレクトリは `kamal accessory remove` コマンドで削除されます。
削除されては困るファイルを置く場合は絶対パスで指定するか、 `volumes` を使います。
:::
```

## 制限事項と注意点

1. カスタムブロックのネストは、外側に4つのコロン、内側に3つのコロンを使用する必要があります
2. 複数レベルのネストも可能ですが、深すぎるネストは可読性を損なう可能性があります
3. カスタムブロック内では標準的なMarkdown構文が使用できますが、一部の複雑な構造では予期しない結果になる場合があります
4. リンクカード機能は、URLのみの行に対してのみ適用されます。段落内のURLには適用されません
5. リンクカードのメタデータ取得はAjaxで非同期に行われるため、ページ読み込み直後は通常のリンクとして表示され、その後カードに変わります
6. 外部サイトのURLによっては、メタデータの取得に失敗する場合があります（CORSポリシーやサイトの構造による）

## 今後の拡張可能性

1. **追加のブロックタイプ**:
   - コードブロックの拡張（コピーボタン、行番号表示など）
   - 引用ブロックのカスタマイズ
   - タブ切り替え機能

2. **スタイルのカスタマイズ**:
   - ブロックのテーマ設定
   - ダークモード対応の強化
   - リンクカードのレイアウトバリエーション（横型/縦型など）

3. **インタラクティブ機能の拡張**:
   - アニメーション効果の追加
   - 詳細ブロックの状態保存
   - リンクカードのプレビュー機能（ホバー時に拡大表示など）

4. **リンクカード機能の強化**:
   - メタデータのキャッシュ機能（同じURLに対する重複リクエストの削減）
   - カスタムリンクカードの作成（URLに加えてタイトルや説明を指定可能に）
   - 埋め込みコンテンツのサポート（YouTube、Twitter、Githubなど特定サイト向けの特殊表示）
