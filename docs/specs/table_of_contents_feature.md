# 記事ページ目次機能仕様書

## 概要

記事ページにおいて、文書構造（見出し）から自動的に目次を生成し、ユーザーがページ内を効率的にナビゲーションできるようにする機能。

## 要件

### 機能要件

1. **目次の自動生成**
   - 記事本文の見出し（h2, h3, h4, h5, h6）を自動的に検出
   - 見出しレベルに応じた階層構造を持つ目次を生成
   - 目次項目をクリックすると、対応する見出しへスムーズにスクロール

2. **レスポンシブ対応**
   - モバイル表示: 記事上部に折りたたみ可能な目次を表示
   - デスクトップ表示: 記事本文の右側に固定された目次を表示

3. **スクロール連動機能**
   - 記事をスクロールすると、現在表示されている見出しに対応する目次項目がハイライト
   - ハイライトされた項目が目次の表示範囲外にある場合、自動的にスクロールして表示

### 非機能要件

1. **パフォーマンス**
   - ページ読み込み時に一度だけ目次を生成し、不要な再計算を避ける
   - スクロールイベントの監視は Intersection Observer API を使用し、パフォーマンスを最適化

2. **アクセシビリティ**
   - 目次項目は適切なコントラスト比を持ち、視認性を確保
   - キーボード操作でも目次を利用可能

3. **デザイン**
   - サイト全体のデザインに調和したスタイリング
   - ダークモードに対応

## 技術仕様

### 使用技術

- **フロントエンド**
  - Stimulus.js: 目次の動的生成と操作
  - Tailwind CSS: レスポンシブデザインとスタイリング
  - Intersection Observer API: スクロール位置の監視

### コンポーネント構成

1. **Stimulus コントローラ**
   - `table_of_contents_controller.js`: 目次の生成と操作を担当

2. **HTML 構造**
   - デスクトップ版目次: 記事本文の右側に配置
   - モバイル版目次: 記事上部に折りたたみ要素として配置

### データフロー

1. ページ読み込み時:
   - 記事本文から見出し要素を抽出
   - 見出しに ID を付与
   - 目次 HTML を生成
   - Intersection Observer を設定

2. スクロール時:
   - 表示されている見出しを検出
   - 対応する目次項目をハイライト
   - 必要に応じて目次をスクロール

3. 目次項目クリック時:
   - クリックイベントをキャプチャ
   - 対応する見出しへスムーズにスクロール

## 実装詳細

### HTML 構造

```html
<!-- モバイル用の目次（折りたたみ可能） -->
<div class="md:hidden mt-8 mb-8">
  <details class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md border border-zinc-200 dark:border-zinc-700">
    <summary class="text-lg font-medium cursor-pointer">目次</summary>
    <div class="mt-3" data-table-of-contents-target="tocMobile">
      <!-- 目次がJavaScriptで生成される (モバイル用) -->
    </div>
  </details>
</div>

<!-- デスクトップ用の目次 -->
<aside class="hidden md:block md:w-64 mt-8 md:mt-0">
  <div class="sticky top-8">
    <div class="w-full bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md border border-zinc-200 dark:border-zinc-700">
      <h3 class="text-lg font-medium mb-4">目次</h3>
      <div class="max-h-[70vh] overflow-y-auto pr-2" data-table-of-contents-target="toc">
        <!-- 目次がJavaScriptで生成される (デスクトップ用) -->
      </div>
    </div>
  </div>
</aside>
```

### JavaScript 実装

Stimulus コントローラの主要機能:

1. **目次生成**
   - 記事本文から見出しを抽出
   - 見出しレベルに応じたインデントを適用
   - クリックイベントハンドラを設定

2. **スクロール監視**
   - Intersection Observer で見出しの表示状態を監視
   - 表示されている見出しに対応する目次項目をハイライト

3. **自動スクロール**
   - ハイライトされた項目が目次の表示範囲外にある場合
   - 目次コンテナを自動的にスクロール

## UI/UX 仕様

### デスクトップ表示

- 記事本文の右側に固定表示
- 幅: 16rem (64px)
- 最大高さ: ビューポート高さの70%
- スクロール可能
- 現在の見出しがハイライト表示

### モバイル表示

- 記事上部に折りたたみ要素として表示
- デフォルトでは折りたたまれている
- タップで展開/折りたたみ

### スタイリング

- 背景色: 白（ダークモード: 暗いグレー）
- 境界線: 薄いグレー（ダークモード: 暗いグレー）
- 影: 軽い影効果
- 角丸: 中程度の丸み
- ハイライト色: 青（ダークモード: 明るい青）

## テスト項目

1. **機能テスト**
   - 目次が正しく生成されるか
   - 目次項目クリックで対応する見出しにスクロールするか
   - スクロール時に正しい目次項目がハイライトされるか
   - ハイライトされた項目が表示範囲外の場合、自動的にスクロールするか

2. **レスポンシブテスト**
   - モバイル表示で目次が折りたたみ要素として表示されるか
   - デスクトップ表示で目次が右側に固定表示されるか
   - 画面サイズ変更時に適切に切り替わるか

3. **ブラウザ互換性テスト**
   - 主要ブラウザで正常に動作するか
   - 古いブラウザでの代替動作は適切か

## 今後の拡張可能性

1. **アニメーション強化**
   - 目次項目のハイライト切り替え時のアニメーション
   - スクロール時のスムーズな遷移効果

2. **カスタマイズオプション**
   - 管理画面からの目次表示/非表示の切り替え
   - 特定の見出しレベルのみを目次に含める設定

3. **印刷対応**
   - 印刷時に目次を適切に表示/非表示
