# 006_Markdown画像表示機能の実装

## ステータス

承認済み

## 日付

2025-05-18

## コンテキスト

Markdownで記述された原稿に画像を表示する機能が必要となっている。ユーザーが原稿内で画像ファイルパスを記述すると、生成されるHTMLページに画像を適切に表示できるようにする必要がある。

現在のシステムでは、以下のカスタムMarkdown拡張機能が実装されている：
- リンクカード機能（URLのみの行をカード表示）
- Mermaid図表機能（コードブロックで記述された図表を描画）
- 詳細ブロック、メッセージブロック、アラートブロックなど

これらの拡張機能と同様に、画像表示機能も既存のカスタムMarkdown拡張の仕組みを活用して実装する必要がある。

## 決定

Markdownの画像表示機能を以下の仕様で実装することを決定した：

1. 以下の構文バリエーションをサポートする：
   - 基本的な画像表示: `![](画像ファイルパス)`
   - 画像の横幅を指定: `![](画像ファイルパス =250px)`
   - Altテキストを指定: `![Altテキスト](画像ファイルパス)`
   - キャプションを追加: 画像の直後に`*キャプション*`を配置
   - 画像にリンクを設定: `[![](画像ファイルパス)](リンクURL)`

2. 画像ファイルパスの解決ルール：
   - 絶対パス（`/`で始まる）: そのまま使用し、`public`ディレクトリから提供
   - 相対パス（`/`で始まらない）: `/assets/images/`配下のパスに変換
   - URL（`http://`または`https://`で始まる）: そのまま使用

3. 実装方法：
   - `CustomMarkdownExtensions`モジュールに`ImageExtension`を追加
   - `ApplicationService`基底クラスを作成し、サービスオブジェクトパターンを導入
   - `AssetPathResolver`サービスを実装し、Asset Pipeline対応のパス解決を行う
   - 画像を`<figure>`要素で囲み、TailwindCSSでスタイリング
   - キャプションは`<figcaption>`要素として実装

4. ActiveStorageは使用せず、ファイルシステムベースのアプローチを採用する
5. Asset Pipelineを活用し、`app/assets/images`ディレクトリの画像を適切に参照できるようにする

## 結果

この決定により、以下の結果が予想される：

### ポジティブな影響

1. ユーザーは標準的なMarkdown構文に近い形式で画像を挿入できるようになり、学習コストが低減される
2. 画像の幅指定やキャプション追加など、拡張機能によって表現力が向上する
3. TailwindCSSによる一貫したスタイリングにより、レスポンシブで美しい画像表示が可能になる
4. ファイルシステムベースのアプローチにより、コンテンツと画像をバージョン管理システムで一元管理できる
5. 既存のカスタムMarkdown拡張の仕組みを活用することで、実装の一貫性が保たれる

### ネガティブな影響

1. 画像ファイルの配置場所（`public`ディレクトリまたは`app/assets/images`ディレクトリ）を理解する必要がある
2. 画像ファイルの管理（アップロード、削除など）は別途行う必要がある
3. 画像の変換処理（リサイズ、最適化など）は別途実装する必要がある
4. 構文の拡張により、標準的なMarkdownパーサーとの互換性が低下する可能性がある
5. サービスオブジェクトパターンの導入により、コードの複雑性が若干増加する

## 代替案

### 1. ActiveStorageを使用した画像管理

#### メリット
- 画像のアップロード、変換、保存が統合的に管理できる
- クラウドストレージ（S3など）への保存が容易
- バリエーション（サムネイル、リサイズなど）の自動生成

#### デメリット
- 実装が複雑になる
- データベースマイグレーションが必要
- Markdownの標準的な使用パターンから逸脱する
- コンテンツとその関連画像のバージョン管理が分離される

#### 採用しなかった理由
- Markdownは元々、静的なコンテンツを記述するために設計されており、ファイルパスで画像を参照するのが標準的
- コンテンツ作成ワークフローの簡素化（ファイルシステムに直接配置する方が作業効率が良い）
- コンテンツと画像を一緒にバージョン管理できる利点
- 静的アセットとしての扱いが適切（頻繁に変更されない）
- シンプルな実装と保守性の確保

### 2. 標準的なMarkdown画像構文のみをサポート

#### メリット
- 実装がシンプル
- 標準的なMarkdownパーサーとの互換性が高い

#### デメリット
- 画像の幅指定やキャプション追加などの拡張機能が使えない
- 表現力が制限される

#### 採用しなかった理由
- ユーザーの要求に応じた柔軟な画像表示機能が必要
- 既存のカスタムMarkdown拡張と同様に、標準を拡張して機能を強化する方針と一致

### 3. HTMLタグの直接記述を許可

#### メリット
- 最大限の柔軟性（任意のHTML属性やスタイルを適用可能）
- 既存のHTMLパーサーを活用できる

#### デメリット
- Markdownの可読性と簡潔さが損なわれる
- セキュリティリスク（XSS攻撃の可能性）
- 一貫したスタイリングの適用が難しい

#### 採用しなかった理由
- Markdownの簡潔さと可読性を維持したい
- セキュリティリスクを最小限に抑えたい
- 一貫したスタイリングを適用したい

## 参考資料

- [Markdown画像構文](https://www.markdownguide.org/basic-syntax/#images)
- [Redcarpet GitHub](https://github.com/vmg/redcarpet)
- [TailwindCSS Documentation](https://tailwindcss.com/docs)
- [HTML figure Element](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/figure)
- [Rails Asset Pipeline](https://guides.rubyonrails.org/asset_pipeline.html)
- [Service Object Pattern](https://www.toptal.com/ruby-on-rails/rails-service-objects-tutorial)
